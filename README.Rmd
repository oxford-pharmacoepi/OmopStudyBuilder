---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# OmopStudyBuilder <a href="https://github.com/oxford-pharmacoepi/OmopStudyBuilder"><img src="man/figures/image.jfif" align="right" height="138" alt="OmopStudyBuilder logo" /></a>

<!-- badges: start -->

[![R-CMD-check](https://github.com/oxford-pharmacoepi/OmopStudyBuilder/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/oxford-pharmacoepi/OmopStudyBuilder/actions/workflows/R-CMD-check.yaml)
[![CRAN status](https://www.r-pkg.org/badges/version/OmopStudyBuilder)](https://CRAN.R-project.org/package=OmopStudyBuilder)
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
[![Codecov test coverage](https://codecov.io/gh/oxford-pharmacoepi/OmopStudyBuilder/branch/main/graph/badge.svg)](https://app.codecov.io/gh/oxford-pharmacoepi/OmopStudyBuilder?branch=main)

<!-- badges: end -->

The goal of **OmopStudyBuilder** is to help you prepare a study for network studies using the OMOP Common Data Model (CDM). The package sets up an R project for your study with a default folder structure and template code typically required for network studies. This allows you to focus on the parts of the analysis that are specific to your study design.

In addition to project setup, the package also provides utilities for reviewing study code and its dependencies, helping ensure reproducibility, consistency, and alignment with best practices.

The package is highly opinionated and designed to align with the OxInfer study code checklist. For further details, please refer to the formal documentation at:
[https://oxford-pharmacoepi.github.io/Oxinfer/onboarding/code_review.html](https://oxford-pharmacoepi.github.io/Oxinfer/onboarding/code_review.html)

# Installation

You can install the development version of the package from GitHub:

```{r, eval = FALSE}
# install.packages("remotes")
remotes::install_github("oxford-pharmacoepi/OmopStudyBuilder")
```

# Example Usage

OmopStudyBuilder provides a complete workflow for creating, reviewing, and distributing OMOP network studies. The package guides you from initial project setup through to Docker-based execution that ensures reproducibility across data partners.

## Step 1: Create Study Structure

Create your study project:

```{r, eval = FALSE}
library(OmopStudyBuilder)
OmopStudyBuilder::createStudy(here::here("SampleStudy"))
```

This creates a standardized folder structure with template code for OMOP network studies.

## Step 2: Review Your Study

As you develop your analysis code, use the review functions to check code quality and dependencies:

```{r, eval = FALSE}
# Review study code files
reviewStudyCode(here::here("SampleStudy/study_code"))

# Review package dependencies
reviewStudyDependencies(here::here("SampleStudy/study_code"))
```

These functions help ensure your study meets best practices and identifies potential issues before distribution.

## Step 3: Lock Package Versions

Initialize package version control for your study:

```{r, eval = FALSE}
# Initialize renv (first time only)
initRenv("SampleStudy/study_code")

# Install required packages (navigate to study directory first)
setwd("SampleStudy/study_code")
install.packages(c("dplyr", "CDMConnector", "IncidencePrevalence"))
setwd("../..")  # Return to original directory

# Lock package versions
snapshotPackages("SampleStudy/study_code")
```

This creates an `renv.lock` file that ensures all data partners use identical package versions.

## Step 4: Build Docker Image

Package your study into a reproducible Docker container:

```{r, eval = FALSE}
# Check Docker is available
checkDocker()

# Build Docker image with locked package versions
OmopStudyBuilder::buildStudy(here::here())
#> Building Docker image: omop-study-study-code
#> This may take 5-15 minutes on first build...
#> Image built successfully: omop-study-study-code
```

The Docker image contains your study code, exact R version, and all dependencies.

## Step 5: Run Study in Docker

Execute your study in an isolated, reproducible environment:

```{r, eval = FALSE}
runStudy(data_path = "path/to/data")
#> Available Docker images:
#>   1. omop-study-study-code
#>   2. postgres
#>   3. rocker/r-ver
#> 
#> Select image (1-3): 1
#> ✔ Selected: omop-study-study-code
#> 
#> Running study in Docker...
#> ════════════════════════════════════════════════════════════════════════
#> [study execution output...]
#> ════════════════════════════════════════════════════════════════════════
#> ✔ Done! Results in: ./results
```

You can also specify the image directly to skip the interactive prompt:

```{r, eval = FALSE}
runStudy(
  image_name = "omop-study-study-code",
  data_path = "path/to/data",
  output_path = "./results"
)
```

## Alternative: One-Command Sync

For ongoing development, use `syncStudy()` to snapshot, build, validate, and test in one step:

```{r, eval = FALSE}
syncStudy(
  study_path = "SampleStudy/study_code",
  force_rebuild = FALSE,
  run_test = TRUE
)
#> ══ SYNCING STUDY ENVIRONMENT ══
#> 
#> ── [1/4] Snapshotting package versions...
#> ✔ Packages updated in renv.lock
#> 
#> ── [2/4] Building Docker image...
#> ✔ Image up-to-date, skipping rebuild
#> 
#> ── [3/4] Validating Docker environment...
#> ✔ Environment validated successfully!
#>   • Local: 45 packages
#>   • Docker: 45 packages
#> 
#> ── [4/4] Testing study execution in Docker...
#> ✔ Study executed successfully in Docker!
#> 
#> ══ SYNC COMPLETE ══
#> ✔ Study environment synchronized and validated
```

This ensures your local environment and Docker image are always in sync.
