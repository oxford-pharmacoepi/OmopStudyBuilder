---
output:
  github_document:
    html_preview: true
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# OmopStudyBuilder <a href="https://github.com/oxford-pharmacoepi/OmopStudyBuilder"><img src="man/figures/image.jfif" align="right" height="138" alt="OmopStudyBuilder logo" /></a>

<!-- badges: start -->

[![R-CMD-check](https://github.com/oxford-pharmacoepi/OmopStudyBuilder/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/oxford-pharmacoepi/OmopStudyBuilder/actions/workflows/R-CMD-check.yaml)
[![CRAN status](https://www.r-pkg.org/badges/version/OmopStudyBuilder)](https://CRAN.R-project.org/package=OmopStudyBuilder)
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
[![Codecov test coverage](https://codecov.io/gh/oxford-pharmacoepi/OmopStudyBuilder/branch/main/graph/badge.svg)](https://app.codecov.io/gh/oxford-pharmacoepi/OmopStudyBuilder?branch=main)

<!-- badges: end -->

The goal of **OmopStudyBuilder** is to help you prepare a study for network studies using the OMOP Common Data Model (CDM). The package sets up an R project for your study with a default folder structure and template code typically required for network studies. This allows you to focus on the parts of the analysis that are specific to your study design.

In addition to project setup, the package also provides utilities for reviewing study code and its dependencies, helping ensure reproducibility, consistency, and alignment with best practices.

The package is highly opinionated and designed to align with the OxInfer study code checklist. For further details, please refer to the formal documentation at:
[https://oxford-pharmacoepi.github.io/Oxinfer/onboarding/code_review.html](https://oxford-pharmacoepi.github.io/Oxinfer/onboarding/code_review.html)

# Installation

You can install the development version of the package from GitHub:

```{r, eval = FALSE}
# install.packages("remotes")
remotes::install_github("oxford-pharmacoepi/OmopStudyBuilder")
```

# Example Usage

OmopStudyBuilder provides a complete workflow for creating, reviewing, and distributing OMOP network studies. The package guides you from initial project setup through to Docker-based execution that ensures reproducibility across data partners.

## Step 1: Create Study Structure

Create your study project:

```{r, eval = FALSE}
library(OmopStudyBuilder)
OmopStudyBuilder::createStudy(here::here("SampleStudy"))
```

This creates a standardized folder structure with template code for OMOP network studies.

## Step 2: Review Your Study

As you develop your analysis code, use the review functions to check code quality and dependencies:

```{r, eval = FALSE}
# Review study code files
reviewStudyCode(here::here("SampleStudy/study_code"))

# Review package dependencies
reviewStudyDependencies(here::here("SampleStudy/study_code"))
```

These functions help ensure your study meets best practices and identifies potential issues before distribution.

## Step 3: Lock Package Versions

Initialize package version control for your study. OmopStudyBuilder expects a
`renv.lock` in your study folder (typically `SampleStudy/study_code`).

```{r, eval = FALSE}
# First time only: initialize renv in your study folder
renv::init(here::here("SampleStudy/study_code"))
install.packages(c("dplyr", "CDMConnector", "IncidencePrevalence"))
renv::snapshot(here::here("SampleStudy/study_code"))
```

This creates an `renv.lock` file that ensures all data partners use identical package versions.

## Step 4: Build Docker Image

Package your study into a reproducible Docker container:

```{r, eval = FALSE}
# Build Docker image from your study folder (where renv.lock lives)
OmopStudyBuilder::buildStudy(path = here::here("SampleStudy/study_code"))
```

The Docker image contains your study code, exact R version, and all dependencies.

## Step 5: Run Study

You have two options to execute your study:

### Option A: Interactive RStudio (Recommended for Data Partners)

Launch RStudio Server in your browser for interactive execution:

```{r, eval = FALSE}
runRStudio()
```

Edit `code_to_run.R` in RStudio to set your database credentials (or use a `.env`
file and pass it with `env_file = ".env"`), then run the analysis interactively.

### Option B: Automated Execution

Run the study as a non-interactive script:

```{r, eval = FALSE}
runStudy()
```

You can also specify the image directly to skip the interactive prompt:

```{r, eval = FALSE}
runStudy(
  image_name = "omop-study-study-code",
  data_path = "path/to/data",
  results_path = "./results"
)
```

## Step 6: Distribute to Data Partners

To distribute a study, share the **study folder** created by
`createStudy()` (including the `study_code/` project and its `renv.lock`).
Data partners can then build and run the study using OmopStudyBuilder functions
without needing to run Docker commands manually.

### Data partner workflow

```{r, eval = FALSE}
install.packages("OmopStudyBuilder")
library(OmopStudyBuilder)

# 1) Build the study image from the provided study folder
buildStudy(path = here::here("SampleStudy/study_code"))

# 2) Run the study (automated)
runStudy()

# Or: run interactively in RStudio Server
runRStudio()

# 3) Stop the running container when finished
stopStudy()
```
